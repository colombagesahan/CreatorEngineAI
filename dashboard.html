<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CreatorEngineAI - Studio</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #050505; color: white; overflow-x: hidden; }
        .glass-panel { background: rgba(20, 20, 35, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.8); }
        .recording-pulse { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .range-slider { -webkit-appearance: none; width: 100%; height: 4px; background: #374151; border-radius: 2px; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #3B82F6; border-radius: 50%; cursor: pointer; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="mainApp()" x-init="initApp()" class="min-h-screen flex flex-col relative" x-cloak>

    <!-- LOADING -->
    <div x-show="loading" class="fixed inset-0 z-[60] bg-black flex flex-col items-center justify-center gap-4">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest animate-pulse">Loading...</p>
    </div>

    <!-- PAYMENT WALL -->
    <div x-show="!loading && subscriptionState === 'locked'" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex flex-col items-center justify-start p-6 overflow-y-auto">
        <div class="w-full max-w-sm space-y-6 mt-10">
            <div class="text-center"><i class="fas fa-lock text-4xl text-red-500 mb-4"></i><h2 class="text-xl font-black text-white">Trial Expired</h2></div>
            <div class="glass-panel p-5 rounded-xl border-l-4 border-yellow-500 space-y-4">
                <h3 class="text-xs font-bold text-yellow-500 uppercase tracking-wider">Unlimited Access</h3>
                <p class="text-2xl font-black">Rs. 1000 <span class="text-xs font-normal text-gray-400">/mo</span></p>
                <div class="bg-gray-900/50 p-4 rounded-lg space-y-2 text-xs border border-gray-800">
                    <div class="flex justify-between"><span class="text-gray-500">Bank:</span> <span class="font-bold">Commercial Bank</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Account:</span> <span class="font-mono font-bold text-lg text-yellow-400">8750053306</span></div>
                </div>
            </div>
            <div class="space-y-3">
                <input type="file" accept="image/*" @change="handleSlipUpload" class="block w-full text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
            </div>
            <button @click="logout()" class="text-xs text-red-500 font-bold mt-4">Sign Out</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div x-show="!loading && (subscriptionState === 'active' || subscriptionState === 'trial' || subscriptionState === 'pending')" class="flex-1 flex flex-col max-w-2xl mx-auto w-full border-x border-gray-900 shadow-2xl">
        <div class="p-4 border-b border-gray-800 bg-black/90 backdrop-blur z-30 sticky top-0 flex justify-between items-center">
            <div><h1 class="text-lg font-black text-white">CreatorEngine<span class="text-[9px] text-gray-500">AI</span></h1></div>
            <button @click="logout()" class="text-[10px] text-red-400">Logout</button>
        </div>

        <div class="flex-1 p-4">
            <!-- STEP 1 -->
            <div x-show="step === 1" class="space-y-6">
                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-500">1. Strategy</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div @click="mode = 'quick'" class="glass-panel p-4 rounded-xl cursor-pointer border-2" :class="mode === 'quick' ? 'border-blue-600' : 'border-transparent'">
                            <div class="text-2xl mb-2">ðŸš€</div><h3 class="font-bold text-sm">Quick Mode</h3><p class="text-[10px] text-gray-400">AI Voice</p>
                        </div>
                        <div @click="mode = 'creator'" class="glass-panel p-4 rounded-xl cursor-pointer border-2" :class="mode === 'creator' ? 'border-blue-600' : 'border-transparent'">
                            <div class="text-2xl mb-2">ðŸ’°</div><h3 class="font-bold text-sm">Money Mode</h3><p class="text-[10px] text-green-400">Your Voice</p>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-500">2. Target</label>
                    <select x-model="targetCountry" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-3 text-sm text-white"><option value="USA">USA</option><option value="UK">UK</option><option value="Australia">Australia</option></select>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between"><label class="text-xs font-bold text-gray-500">3. Topic</label><button @click="generateTrendingTopic()" :disabled="trendLoading" class="text-[10px] bg-purple-600 px-2 rounded">Auto-Find</button></div>
                    <textarea x-model="topic" rows="2" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-sm text-white" placeholder="Topic..."></textarea>
                </div>
                <button @click="generateScript()" :disabled="aiLoading" class="w-full py-4 rounded-xl font-black text-white bg-blue-600 hover:bg-blue-500">CREATE VIDEO</button>
            </div>

            <!-- STEP 2 -->
            <div x-show="step === 2" class="space-y-6">
                <div class="glass-panel p-3 rounded-xl border border-gray-700/50 flex flex-col gap-3">
                    <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-gray-400">AUDIO MIXER</span><label class="cursor-pointer bg-gray-800 text-white text-[9px] px-2 py-1 rounded">Upload Music<input type="file" class="hidden" accept="audio/*" @change="handleMusicUpload"></label></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[9px] text-gray-500">Voice</label><input type="range" x-model="voiceVol" min="0" max="1" step="0.1" class="range-slider"></div>
                        <div><label class="text-[9px] text-gray-500">Music</label><input type="range" x-model="musicVol" min="0" max="1" step="0.1" class="range-slider"></div>
                    </div>
                </div>

                <template x-for="(scene, index) in scenes" :key="index">
                    <div class="glass-panel rounded-xl p-4 border-l-4" :style="`border-left-color: ${scene.color}`">
                        <div class="flex justify-between mb-3"><span class="text-[10px] font-bold" x-text="'SCENE ' + (index+1)"></span><button @click="scenes.splice(index, 1)"><i class="fas fa-trash"></i></button></div>
                        <div class="flex gap-4">
                            <div class="w-24 h-24 bg-gray-900 rounded-lg relative flex items-center justify-center cursor-pointer overflow-hidden border border-gray-700" @click="$refs['f'+index].click()">
                                <img x-show="scene.media_url" :src="scene.media_url" class="w-full h-full object-cover">
                                <i x-show="!scene.media_url" class="fas fa-cloud-upload-alt text-gray-500"></i>
                                <input :x-ref="'f'+index" type="file" class="hidden" accept="image/*" @change="handleUpload($event, index)">
                            </div>
                            <div class="flex-1 space-y-2">
                                <textarea x-model="scene.text" rows="2" class="w-full bg-transparent border-b border-gray-700 text-sm text-white"></textarea>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" x-model="scene.duration" class="bg-gray-900 rounded text-xs px-2 py-1 text-white">
                                    <input type="color" x-model="scene.color" class="w-full h-6 bg-transparent">
                                </div>
                                <div x-show="mode === 'creator'" class="bg-gray-900 p-2 rounded flex justify-between">
                                    <button @mousedown="startRecording(index)" @mouseup="stopRecording(index)" class="w-8 h-8 rounded-full bg-red-600 text-white flex items-center justify-center"><i class="fas fa-microphone"></i></button>
                                    <button x-show="scene.audio_blob" @click="playRecording(index)" class="text-green-400 text-xs">Play</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <div class="flex gap-2">
                    <button @click="addScene()" class="flex-1 py-2 bg-gray-900 rounded text-xs text-white">Add Scene</button>
                    <button @click="startRendering()" class="flex-1 py-2 bg-green-600 rounded text-xs text-white font-bold">RENDER VIDEO</button>
                </div>
            </div>

            <!-- STEP 3 -->
            <div x-show="step === 3" class="flex flex-col items-center gap-4">
                 <video :src="videoURL" controls class="w-full rounded-xl border border-gray-800 shadow-2xl bg-black aspect-[9/16]"></video>
                 <a :href="videoURL" download="viral_short.webm" class="w-full bg-blue-600 text-white py-3 rounded-xl text-center font-bold text-xs uppercase">Download Video</a>
                 <button @click="step=1" class="text-xs text-gray-500">New Project</button>
            </div>
        </div>
        <canvas id="videoCanvas" class="hidden"></canvas>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAE88FW3US3aZRn5TLEdXkad-jvak3W4yI",
            authDomain: "sahantechhub.firebaseapp.com",
            projectId: "sahantechhub",
            storageBucket: "sahantechhub.firebasestorage.app",
            messagingSenderId: "605792804808",
            appId: "1:605792804808:web:531be19ce5f6a4a17faafd",
            measurementId: "G-JMSXWQ964T"
        };

        let auth, db, storage, functions, onAuthStateChanged, signOut, doc, getDoc, setDoc, updateDoc, serverTimestamp, ref, uploadBytes, getDownloadURL, httpsCallable;

        function mainApp() {
            return {
                loading: true, user: null, subscriptionState: 'loading', uploading: false,
                step: 1, mode: 'quick', format: '9:16', targetCountry: 'USA', topic: '', 
                scenes: [], aiLoading: false, trendLoading: false, videoURL: null,
                voiceVol: 1.0, musicVol: 0.15, recordingIndex: null, recStartTime: 0,
                bgMusicFile: null, bgMusicBuffer: null, audioCtx: null, dest: null,

                async initApp() {
                    const appM = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
                    const authM = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                    const fireM = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const storM = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js");
                    const funcM = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js");

                    const fbApp = appM.initializeApp(firebaseConfig);
                    auth = authM.getAuth(fbApp);
                    db = fireM.getFirestore(fbApp);
                    storage = storM.getStorage(fbApp);
                    functions = funcM.getFunctions(fbApp);
                    
                    onAuthStateChanged = authM.onAuthStateChanged;
                    signOut = authM.signOut;
                    doc = fireM.doc; getDoc = fireM.getDoc; setDoc = fireM.setDoc; updateDoc = fireM.updateDoc; serverTimestamp = fireM.serverTimestamp;
                    ref = storM.ref; uploadBytes = storM.uploadBytes; getDownloadURL = storM.getDownloadURL;
                    httpsCallable = funcM.httpsCallable;

                    onAuthStateChanged(auth, async (u) => {
                        if (!u) { window.location.href = "index.html"; return; }
                        this.user = u;
                        await this.checkSubscription(u);
                    });
                },

                async checkSubscription(user) {
                    const snap = await getDoc(doc(db, "users", user.uid));
                    if (!snap.exists()) {
                        await setDoc(doc(db, "users", user.uid), { email: user.email, trial_start: serverTimestamp(), status: 'trial' });
                        this.subscriptionState = 'trial';
                    } else {
                        const data = snap.data();
                        if (data.status === 'active' || data.status === 'pending') {
                            this.subscriptionState = data.status;
                        } else {
                            const now = Date.now();
                            const start = data.trial_start ? data.trial_start.toMillis() : now;
                            this.subscriptionState = (now - start) > (24*60*60*1000) ? 'locked' : 'trial';
                        }
                    }
                    this.loading = false;
                },

                getStatusText() { return this.subscriptionState === 'trial' ? '24H Free Trial' : (this.subscriptionState === 'active' ? 'Pro Plan' : 'Pending'); },

                async handleSlipUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    this.uploading = true;
                    try {
                        const r = ref(storage, `slips/${this.user.uid}/${Date.now()}_${file.name}`);
                        await uploadBytes(r, file);
                        const url = await getDownloadURL(r);
                        await updateDoc(doc(db, "users", this.user.uid), { status: 'pending', slip_url: url });
                        this.subscriptionState = 'pending';
                        alert("Receipt Uploaded!");
                    } catch (err) { alert("Upload failed"); }
                    this.uploading = false;
                },

                async generateTrendingTopic() {
                    this.trendLoading = true;
                    try {
                        const fn = httpsCallable(functions, 'findTrendingTopic');
                        const res = await fn({ country: this.targetCountry });
                        this.topic = res.data.topic;
                    } catch(e) { this.topic = "5 Facts About " + this.targetCountry; }
                    this.trendLoading = false;
                },

                async generateScript() {
                    if(!this.topic) return alert("Enter a topic");
                    this.aiLoading = true;
                    try {
                        const fn = httpsCallable(functions, 'generateVideoScript');
                        const res = await fn({ topic: this.topic, country: this.targetCountry });
                        const data = res.data;
                        this.scenes = data.scenes.map(s => ({ text: s.text, color: s.color_hex || '#3B82F6', media_url: null, duration: 5, recDuration: 0, audio_blob: null }));
                        this.step = 2;
                    } catch(e) { alert("AI Error. Try different topic."); }
                    this.aiLoading = false;
                },

                addScene() { this.scenes.push({ text: "", media_url: null, color: '#00CCFF', duration: 5, recDuration: 0, audio_blob: null }); },
                handleUpload(e, i) { if(e.target.files[0]) this.scenes[i].media_url = URL.createObjectURL(e.target.files[0]); },
                
                // AUDIO MIXER & RECORDER (RESTORED)
                handleMusicUpload(e) {
                    const file = e.target.files[0];
                    if(file) {
                        this.bgMusicFile = file;
                        if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        const reader = new FileReader();
                        reader.onload = async (ev) => { this.bgMusicBuffer = await this.audioCtx.decodeAudioData(ev.target.result); };
                        reader.readAsArrayBuffer(file);
                    }
                },

                async startRecording(i) {
                    this.recordingIndex = i;
                    this.recStartTime = Date.now();
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.scenes[i].mediaRecorder = new MediaRecorder(stream);
                        this.scenes[i].chunks = [];
                        this.scenes[i].mediaRecorder.ondataavailable = e => this.scenes[i].chunks.push(e.data);
                        this.scenes[i].mediaRecorder.start();
                    } catch(e) { alert("Mic Error"); }
                },

                stopRecording(i) {
                    if(this.scenes[i].mediaRecorder) {
                        this.scenes[i].mediaRecorder.stop();
                        this.scenes[i].mediaRecorder.onstop = () => {
                            const blob = new Blob(this.scenes[i].chunks, { type: 'audio/webm' });
                            this.scenes[i].audio_blob = blob;
                            this.scenes[i].recDuration = ((Date.now() - this.recStartTime)/1000).toFixed(1);
                            this.recordingIndex = null;
                        };
                    }
                },

                playRecording(i) { if(this.scenes[i].audio_blob) new Audio(URL.createObjectURL(this.scenes[i].audio_blob)).play(); },
                
                playGuide(text) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    window.speechSynthesis.speak(u);
                },

                // CLIENT SIDE RENDERER (RESTORED FOR SPEED & FEATURES)
                async startRendering() {
                    const canvas = document.getElementById('videoCanvas');
                    canvas.width = 1080; canvas.height = 1920;
                    const ctx = canvas.getContext('2d');
                    if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    this.dest = this.audioCtx.createMediaStreamDestination();
                    
                    const stream = canvas.captureStream(30);
                    // Add audio tracks
                    if(this.bgMusicBuffer) {
                        const s = this.audioCtx.createBufferSource(); s.buffer = this.bgMusicBuffer; s.loop = true;
                        const g = this.audioCtx.createGain(); g.gain.value = this.musicVol;
                        s.connect(g); g.connect(this.dest); s.start(0);
                    }
                    
                    const tracks = [...stream.getVideoTracks(), ...this.dest.stream.getAudioTracks()];
                    const combined = new MediaStream(tracks);
                    const recorder = new MediaRecorder(combined, { mimeType: 'video/webm; codecs=vp9' });
                    const chunks = [];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.start();

                    this.loading = true;

                    for (const scene of this.scenes) {
                        if(scene.audio_blob) {
                            const ab = await scene.audio_blob.arrayBuffer();
                            const buf = await this.audioCtx.decodeAudioData(ab);
                            const s = this.audioCtx.createBufferSource(); s.buffer = buf;
                            const g = this.audioCtx.createGain(); g.gain.value = this.voiceVol;
                            s.connect(g); g.connect(this.dest); s.start(0);
                        } else {
                            // TTS Fallback
                            const u = new SpeechSynthesisUtterance(scene.text);
                            window.speechSynthesis.speak(u);
                        }

                        // ANIMATION LOOP (Simplified)
                        const frames = scene.duration * 30;
                        for(let f=0; f<frames; f++) {
                            ctx.fillStyle = scene.color; ctx.fillRect(0,0,1080,1920);
                            if(scene.media_url) {
                                const img = new Image(); img.src = scene.media_url;
                                await new Promise(r => img.onload = r);
                                ctx.drawImage(img, 0, 0, 1080, 1920);
                            }
                            ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(50, 1400, 980, 400);
                            ctx.fillStyle = 'white'; ctx.font = '60px Arial'; ctx.textAlign = 'center';
                            ctx.fillText(scene.text, 540, 1600);
                            await new Promise(r => setTimeout(r, 10)); // Speed control
                        }
                    }

                    recorder.stop();
                    recorder.onstop = () => {
                        this.videoURL = URL.createObjectURL(new Blob(chunks, {type: 'video/webm'}));
                        this.step = 3;
                        this.loading = false;
                    };
                },

                logout() { signOut(auth).then(() => window.location.href = "index.html"); }
            }
        }
    </script>
</body>
</html>
