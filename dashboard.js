import {FFmpeg}from"https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/esm/index.js";import{fetchFile,toBlobURL}from"https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/esm/index.js";import Alpine from"https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/module.esm.js";

// --- START ENCRYPTED LOGIC ---
(function(){var _0x1a="\x63\x6f\x6c\x6f\x6d\x62\x61\x67\x65\x73\x61\x68\x61\x6e\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f";var _0x2b=window.location.hostname;if(_0x2b!==_0x1a&&_0x2b!=="\x31\x32\x37\x2e\x30\x2e\x30\x2e\x31"&&_0x2b!=="\x6c\x6f\x63\x61\x6c\x68\x6f\x73\x74"&&_0x2b!==""){document.body.innerHTML="<div style='display:flex;height:100vh;align-items:center;justify-content:center;background:#000;color:red;font-family:monospace;text-align:center;'><h1>‚ö†Ô∏è THEFT DETECTED<br>INVALID DOMAIN</h1></div>";throw new Error("\x41\x63\x63\x65\x73\x73\x20\x44\x65\x6e\x69\x65\x64");}})();const _0xconsole=console.warn;console.warn=(..._0xargs)=>{if(_0xargs[0]&&typeof _0xargs[0]==='string'&&_0xargs[0].includes('cdn.tailwindcss.com'))return;_0xconsole.apply(console,_0xargs);};

// Updated Logic to force reliable model
window.videoApp=function(){return{step:1,mode:'quick',format:'9:16',topic:'',targetCountry:'USA',loading:false,processing:false,progressText:'',videoURL:null,
apiKey:"\x41\x49\x7a\x61\x53\x79\x42\x58\x38\x73\x67\x51\x46\x6c\x53\x56\x6d\x31\x43\x74\x4f\x54\x31\x50\x76\x72\x4d\x63\x6a\x48\x72\x59\x47\x76\x56\x51\x77\x38\x4d",
ffmpeg:null,converting:false,mp4URL:null,scenes:[],audioCtx:null,dest:null,mediaRecorder:null,audioChunks:[],recordingIndex:null,recStartTime:0,validModel:"gemini-1.5-flash",bgMusicFile:null,bgMusicBuffer:null,voiceVol:1.0,musicVol:0.15,useBgMusic:false,metadataLoading:false,generatedTitle:'',generatedDescription:'',animState:{img:null,video:null,text:"",color:"#fff",zoom:1.0,textY:100,textAlpha:0,fontSize:80,animation:'fade',progress:0},init(){const _0xcvs=document.getElementById('videoCanvas');if(this.format==='9:16'){_0xcvs.width=1080;_0xcvs.height=1920;}else{_0xcvs.width=1920;_0xcvs.height=1080;}},cleanup(){this.scenes.forEach(_0xs=>{if(_0xs.media_url&&_0xs.media_url.startsWith('blob:'))URL.revokeObjectURL(_0xs.media_url);});if(this.videoURL)URL.revokeObjectURL(this.videoURL);if(this.mp4URL)URL.revokeObjectURL(this.mp4URL);},reset(){this.cleanup();this.step=1;this.topic='';this.scenes=[];this.bgMusicFile=null;this.generatedTitle='';this.generatedDescription='';this.mp4URL=null;this.converting=false;},async convertToMP4(){if(!this.videoURL)return alert("No video!");this.converting=true;try{if(!this.ffmpeg){this.ffmpeg=new FFmpeg();const _0xbase='https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm';await this.ffmpeg.load({coreURL:await toBlobURL(`${_0xbase}/ffmpeg-core.js`,'text/javascript'),wasmURL:await toBlobURL(`${_0xbase}/ffmpeg-core.wasm`,'application/wasm'),});}await this.ffmpeg.writeFile('input.webm',await fetchFile(this.videoURL));await this.ffmpeg.exec(['-i','input.webm','-c:v','libx264','-preset','ultrafast','-pix_fmt','yuv420p','output.mp4']);const _0xdata=await this.ffmpeg.readFile('output.mp4');const _0xblob=new Blob([_0xdata.buffer],{type:'video/mp4'});this.mp4URL=URL.createObjectURL(_0xblob);}catch(e){console.error(e);alert("Convert Fail: Needs COI.");}this.converting=false;},async getValidModel(){return "gemini-1.5-flash";},async generateTrendingTopic(){this.loading=true;try{const _0xp=`Give ONE viral YouTube Short topic for ${this.targetCountry}. Return text only.`;const _0xr=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:_0xp}]}]})});const _0xd=await _0xr.json();if(_0xd.error) throw _0xd.error;this.topic=_0xd.candidates[0].content.parts[0].text.trim();}catch(e){console.error(e);alert("Trend Error: "+(e.message||"API Blocked"));}this.loading=false;},async generateScript(){if(!this.topic)return alert("Topic?");this.loading=true;this.init();try{const _0xA=window.AudioContext||window.webkitAudioContext;this.audioCtx=new _0xA();this.dest=this.audioCtx.createMediaStreamDestination();await this.audioCtx.resume();}catch(e){}const _0xp=`Act as a Viral Video Director. Target: ${this.targetCountry}. Topic: "${this.topic}". Create 3 scenes. Scene 1: Hook (< 8 words). Scenes 2-3: Content (< 12 words). For 'color_hex': Pick NEON color (#FF0055, #00CCFF, #00FF99, #FFD700). Return JSON: { "scenes": [ { "text": "...", "color_hex": "..." } ] }`;try{const _0xr=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:_0xp}]}]})});const _0xd=await _0xr.json();if(_0xd.error) throw _0xd.error;let _0xraw=_0xd.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim();const _0xj=JSON.parse(_0xraw);this.scenes=_0xj.scenes.map((s,i)=>({text:s.text,media_url:null,media_type:'none',image_source:'Empty',type:i===0?'hook':'content',color:s.color_hex||'#FFD700',fontSize:80,duration:5,audio_blob:null,isWriting:false,recDuration:0,animation:'fade'}));this.loading=false;this.step=2;}catch(e){console.error(e);alert("AI Error: "+(e.message||"API Blocked"));this.loading=false;}},addScene(){this.scenes.push({text:"",media_url:null,media_type:'none',image_source:'Empty',type:'content',color:'#00CCFF',fontSize:80,duration:5,audio_blob:null,isWriting:false,recDuration:0,animation:'fade'});},addOutro(){this.scenes.push({text:"Thanks for watching! Subscribe üîî",media_url:null,media_type:'none',image_source:'Empty',type:'outro',color:'#00FF99',fontSize:80,duration:5,audio_blob:null,isWriting:false,recDuration:0,animation:'zoom'});},async autoWriteScene(_0xi){this.scenes[_0xi].isWriting=true;const _0xp=`Topic: "${this.topic}". Write ONE short script line (max 10 words, emoji).`;try{const _0xr=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:_0xp}]}]})});const _0xd=await _0xr.json();this.scenes[_0xi].text=_0xd.candidates[0].content.parts[0].text.trim();}catch(e){this.scenes[_0xi].text="Error.";}this.scenes[_0xi].isWriting=false;},handleUpload(e,i){const f=e.target.files[0];if(f){if(this.scenes[i].media_url)URL.revokeObjectURL(this.scenes[i].media_url);this.scenes[i].media_url=URL.createObjectURL(f);this.scenes[i].media_type=f.type.startsWith('video')?'video':'image';this.scenes[i].image_source='Upload';}},handleMusicUpload(e){const f=e.target.files[0];if(f){this.bgMusicFile=f;this.useBgMusic=true;const r=new FileReader();r.onload=async(evt)=>{this.bgMusicBuffer=await this.audioCtx.decodeAudioData(evt.target.result);};r.readAsArrayBuffer(f);}},removeScene(i){if(this.scenes[i].media_url)URL.revokeObjectURL(this.scenes[i].media_url);if(this.scenes.length>1)this.scenes.splice(i,1);},playGuide(t){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t||"Missing");u.lang="en-US";u.rate=0.9;window.speechSynthesis.speak(u);},async startRecording(i){window.speechSynthesis.cancel();this.recordingIndex=i;this.audioChunks=[];this.recStartTime=Date.now();try{const s=await navigator.mediaDevices.getUserMedia({audio:true});this.mediaRecorder=new MediaRecorder(s);this.mediaRecorder.ondataavailable=e=>this.audioChunks.push(e.data);this.mediaRecorder.start();}catch(e){alert("Mic Denied");}},stopRecording(i){if(this.mediaRecorder&&this.mediaRecorder.state!=='inactive'){this.mediaRecorder.stop();this.mediaRecorder.onstop=()=>{const b=new Blob(this.audioChunks,{type:'audio/webm'});this.scenes[i].audio_blob=b;const d=(Date.now()-this.recStartTime)/1000;this.scenes[i].recDuration=d.toFixed(1);this.scenes[i].duration=d.toFixed(1);this.recordingIndex=null;this.mediaRecorder.stream.getTracks().forEach(t=>t.stop());};}},playRecording(i){if(this.scenes[i].audio_blob)new Audio(URL.createObjectURL(this.scenes[i].audio_blob)).play();},async generateMetadata(){this.metadataLoading=true;try{const p=`Act as SEO Expert. Target: ${this.targetCountry}. Topic: "${this.topic}". Generate: 1. Viral Title (max 60 chars). 2. Description (max 100 words, 3 hashtags). Return JSON: { "title": "...", "description": "..." }`;const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}]})});const d=await r.json();let raw=d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim();const j=JSON.parse(raw);this.generatedTitle=j.title;this.generatedDescription=j.description;}catch(e){this.generatedTitle="üî• "+this.topic;this.generatedDescription="#Viral";}this.metadataLoading=false;},async startRendering(){const missing=this.scenes.some(s=>!s.media_url&&s.type!=='outro');if(missing)return alert("Upload visuals!");this.processing=true;if(this.audioCtx.state==='suspended')await this.audioCtx.resume();const cvs=document.getElementById('videoCanvas');const ctx=cvs.getContext('2d');const assets=[];for(let i=0;i<this.scenes.length;i++){this.progressText=`Scene ${i+1}`;const s=this.scenes[i];try{if(s.media_type==='video'){const v=document.createElement('video');v.src=s.media_url;v.muted=true;v.loop=true;await new Promise((res,rej)=>{v.onloadedmetadata=res;v.onerror=rej;v.load();});assets.push({type:'video',el:v});}else{if(!s.media_url){assets.push({type:'placeholder',el:null});}else{const imgP=this.loadImage(s.media_url);const tO=new Promise(r=>setTimeout(()=>r(null),3000));const img=await Promise.race([imgP,tO]);if(!img)assets.push({type:'placeholder',el:null});else assets.push({type:'image',el:img});}}}catch(e){assets.push({type:'placeholder',el:null});}}if(this.bgMusicBuffer&&this.useBgMusic){const s=this.audioCtx.createBufferSource();s.buffer=this.bgMusicBuffer;s.loop=true;const g=this.audioCtx.createGain();g.gain.value=this.musicVol;s.connect(g);g.connect(this.dest);s.start(0);this.bgMusicNode=s;}this.progressText="Rendering...";const cStrm=cvs.captureStream(30);const osc=this.audioCtx.createOscillator();osc.frequency.value=0;const g=this.audioCtx.createGain();g.gain.value=0.001;osc.connect(g);g.connect(this.dest);osc.start();const comb=new MediaStream([...cStrm.getVideoTracks(),...this.dest.stream.getAudioTracks()]);let opt={mimeType:'video/webm; codecs=vp9',videoBitsPerSecond:3500000};if(!MediaRecorder.isTypeSupported('video/webm; codecs=vp9')){opt={mimeType:'video/webm',videoBitsPerSecond:3500000};}const mR=new MediaRecorder(comb,opt);const chks=[];mR.ondataavailable=(e)=>{if(e.data.size>0)chks.push(e.data);};mR.start(100);let isRen=true;const renFrame=()=>{if(!isRen)return;try{ctx.fillStyle="black";ctx.fillRect(0,0,cvs.width,cvs.height);if(this.animState.video){const v=this.animState.video;const vR=v.videoWidth/v.videoHeight;const cR=cvs.width/cvs.height;let dw,dh,dx,dy;if(vR>cR){dh=cvs.height;dw=dh*vR;dy=0;dx=(cvs.width-dw)/2;}else{dw=cvs.width;dh=dw/vR;dx=0;dy=(cvs.height-dh)/2;}ctx.drawImage(v,dx,dy,dw,dh);}else if(this.animState.img){ctx.save();const cx=cvs.width/2;const cy=cvs.height/2;ctx.translate(cx,cy);ctx.scale(this.animState.zoom,this.animState.zoom);ctx.translate(-cx,-cy);const iR=this.animState.img.width/this.animState.img.height;const cR=cvs.width/cvs.height;let dw,dh,dx,dy;if(iR>cR){dh=cvs.height;dw=dh*iR;dy=0;dx=(cvs.width-dw)/2;}else{dw=cvs.width;dh=dw/iR;dx=0;dy=(cvs.height-dh)/2;}ctx.drawImage(this.animState.img,dx,dy,dw,dh);ctx.restore();this.animState.zoom+=0.0015;}else{const grd=ctx.createLinearGradient(0,0,0,cvs.height);grd.addColorStop(0,"#0f0f1a");grd.addColorStop(1,"#1a1a2e");ctx.fillStyle=grd;ctx.fillRect(0,0,cvs.width,cvs.height);}const grad=ctx.createRadialGradient(cvs.width/2,cvs.height/2,cvs.width/3,cvs.width/2,cvs.height/2,cvs.height);grad.addColorStop(0,"rgba(0,0,0,0)");grad.addColorStop(1,"rgba(0,0,0,0.85)");ctx.fillStyle=grad;ctx.fillRect(0,0,cvs.width,cvs.height);if(this.animState.animation==='slide'){if(this.animState.textY>0)this.animState.textY*=0.9;this.animState.textAlpha=Math.min(this.animState.textAlpha+0.05,1);}else if(this.animState.animation==='typewriter'){this.animState.progress+=0.5;this.animState.textAlpha=1;this.animState.textY=0;}else{this.animState.textAlpha=Math.min(this.animState.textAlpha+0.05,1);this.animState.textY=0;}ctx.save();ctx.globalAlpha=this.animState.textAlpha;const bH=cvs.height*0.25;const bY=cvs.height-bH-50;ctx.fillStyle="rgba(0,0,0,0.8)";ctx.beginPath();if(ctx.roundRect)ctx.roundRect(40,bY,cvs.width-80,bH,30);else ctx.rect(40,bY,cvs.width-80,bH);ctx.fill();ctx.fillStyle=this.animState.color;ctx.font=`900 ${this.animState.fontSize}px Montserrat, 'Noto Color Emoji'`;ctx.textAlign="center";ctx.textBaseline="middle";let dT=this.animState.text;if(this.animState.animation==='typewriter'){const cC=Math.floor(this.animState.progress);dT=this.animState.text.substring(0,cC);}this.wrapText(ctx,dT,cvs.width/2,bY+(bH/2)+this.animState.textY,cvs.width*0.8,this.animState.fontSize*1.2);ctx.restore();}catch(e){}requestAnimationFrame(renFrame);};requestAnimationFrame(renFrame);for(let i=0;i<this.scenes.length;i++){const s=this.scenes[i];const a=assets[i];try{if(a&&a.type==='video'){this.animState.video=a.el;this.animState.img=null;a.el.play();}else if(a&&a.type==='image'){this.animState.img=a.el;this.animState.video=null;this.animState.zoom=1.05;}else{this.animState.img=null;this.animState.video=null;}this.animState.text=s.text;this.animState.color=s.color||'#FFD700';this.animState.fontSize=parseInt(s.fontSize)||80;this.animState.animation=s.animation||'fade';this.animState.textY=100;this.animState.textAlpha=0;this.animState.progress=0;const sD=parseFloat(s.duration)*1000;const p1=(this.mode==='creator'&&s.audio_blob)?this.playBlobAudio(s.audio_blob):this.playTTS(s.text,s.duration);await Promise.all([p1,new Promise(r=>setTimeout(r,sD))]);if(a&&a.type==='video')a.el.pause();}catch(e){}}await new Promise(r=>setTimeout(r,2000));isRen=false;if(this.bgMusicNode)this.bgMusicNode.stop();mR.stop();mR.onstop=()=>{this.videoURL=URL.createObjectURL(new Blob(chks,{type:'video/webm'}));this.processing=false;this.step=3;this.generateMetadata();};},async loadImage(url){return new Promise((res)=>{const img=new Image();if(url&&!url.startsWith('blob:'))img.crossOrigin="Anonymous";img.onload=()=>res(img);img.onerror=()=>res(null);img.src=url;});},async playTTS(t,d){return new Promise((res)=>{if(!t)return res();window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.rate=1.0;u.volume=this.voiceVol;u.onend=()=>{res();};u.onerror=()=>{res();};try{window.speechSynthesis.speak(u);}catch(e){res();}setTimeout(res,(t.length*100)+2000);});},async playBlobAudio(b){return new Promise(async(res)=>{try{const ab=await b.arrayBuffer();const buf=await this.audioCtx.decodeAudioData(ab);const s=this.audioCtx.createBufferSource();s.buffer=buf;const g=this.audioCtx.createGain();g.gain.value=this.voiceVol;s.connect(g);g.connect(this.dest);s.onended=()=>{s.disconnect();res();};s.start(0);}catch(e){res();}});},wrapText(ctx,t,x,y,mW,lH){const w=t.split(' ');let l='';let ls=[];for(let n=0;n<w.length;n++){let tL=l+w[n]+' ';if(ctx.measureText(tL).width>mW&&n>0){ls.push(l);l=w[n]+' ';}else{l=tL;}}ls.push(l);let sY=y-((ls.length-1)*lH)/2;ls.forEach((l,i)=>{ctx.fillText(l,x,sY+(i*lH));});}}};Alpine.start();
